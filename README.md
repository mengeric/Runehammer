# Runehammer

> **å¥¥æ©æ›¾æ›¿å¤ä»£å¼—é›·å°”å“å¾·éƒ¨æ—"æŠŠä¸–ç•Œç¬¦æ–‡é’‰è¿›ç°å®"ï¼Œç”¨çš„å°±æ˜¯"ä¸€æŠŠç¬¦æ–‡é”»é”¤"**

Runehammer æ˜¯ä¸€ä¸ªåŸºäº [Grule](https://github.com/hyperjumptech/grule-rule-engine) çš„é€šç”¨è§„åˆ™å¼•æ“ï¼Œä¸“ä¸ºä¸šåŠ¡è§„åˆ™ä¸ä»£ç è§£è€¦ã€çƒ­æ›´æ–°å’Œçµæ´»æ‰©å±•è€Œè®¾è®¡ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### åŸºç¡€åŠŸèƒ½
- ğŸ”¥ **çƒ­æ›´æ–°** - è§„åˆ™å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ›´æ–°
- ğŸ·ï¸ **ä¸šåŠ¡åˆ†ç»„** - é€šè¿‡ä¸šåŠ¡ç (bizCode)ç®¡ç†ä¸åŒåœºæ™¯çš„è§„åˆ™é›†
- ğŸ”€ **æ³›å‹æ”¯æŒ** - æ”¯æŒä»»æ„ç±»å‹çš„è§„åˆ™æ‰§è¡Œç»“æœ
- âš¡ **é«˜æ€§èƒ½ç¼“å­˜** - äºŒçº§ç¼“å­˜æœºåˆ¶(Redis + å†…å­˜)ï¼Œè‡ªåŠ¨å¤±æ•ˆä¸æ‰‹åŠ¨æ¸…ç†
- ğŸ“¦ **ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒè§„åˆ™ç‰ˆæœ¬æ§åˆ¶ï¼Œä¾¿äºç°åº¦å‘å¸ƒå’Œå›æ»š
- ğŸ› ï¸ **ç®€æ´API** - ä¸€è¡Œä»£ç æ‰§è¡Œè§„åˆ™ï¼Œå¼€ç®±å³ç”¨
- ğŸ”Œ **çµæ´»æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰å‡½æ•°æ³¨å…¥å’Œå¤šç§ç¼“å­˜ç­–ç•¥

### åŠ¨æ€è§„åˆ™å¼•æ“
- ğŸš€ **åŠ¨æ€è§„åˆ™ç”Ÿæˆ** - æ”¯æŒå®æ—¶ç”Ÿæˆå’Œæ‰§è¡Œè§„åˆ™ï¼Œæ— éœ€æ•°æ®åº“å­˜å‚¨
- ğŸ”„ **å¤šæ ¼å¼è½¬æ¢** - æ”¯æŒå¤šç§è§„åˆ™æ ¼å¼äº’ç›¸è½¬æ¢ï¼ˆæ ‡å‡†è§„åˆ™ã€ç®€å•è§„åˆ™ã€æŒ‡æ ‡è§„åˆ™ï¼‰
- ğŸŒ **å¤šè¯­æ³•æ”¯æŒ** - æ”¯æŒ SQLã€JavaScript ç­‰è¡¨è¾¾å¼è¯­æ³•
- ğŸ“Š **å†…ç½®å‡½æ•°åº“** - 50+ å†…ç½®å‡½æ•°ï¼Œæ¶µç›–æ•°å­¦ã€å­—ç¬¦ä¸²ã€æ—¶é—´ã€éªŒè¯ç­‰åŠŸèƒ½
- ğŸ”€ **å¹¶è¡Œæ‰§è¡Œ** - æ”¯æŒæ‰¹é‡è§„åˆ™å¹¶è¡Œå¤„ç†ï¼Œæå‡æ‰§è¡Œæ•ˆç‡
- ğŸ¯ **ç¬¬ä¸‰æ–¹é›†æˆ** - æ ‡å‡†åŒ–è§„åˆ™å®šä¹‰æ ¼å¼ï¼Œä¾¿äºç¬¬ä¸‰æ–¹ç³»ç»Ÿæ¥å…¥

## ğŸ—ï¸ è½¯ä»¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡åº”ç”¨å±‚     â”‚â”€â”€â”€â–¶â”‚   Runehammer     â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™å­˜å‚¨å±‚     â”‚
â”‚                 â”‚    â”‚   Core Engine    â”‚    â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ APIè°ƒç”¨       â”‚    â”‚ â€¢ è§„åˆ™ç¼–è¯‘ç¼“å­˜   â”‚    â”‚ â€¢ MySQL/æ•°æ®åº“  â”‚
â”‚ â€¢ ä¸šåŠ¡ç æ ‡è¯†     â”‚    â”‚ â€¢ æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç† â”‚    â”‚ â€¢ è§„åˆ™è¡¨ç»“æ„    â”‚
â”‚ â€¢ è¾“å…¥è¾“å‡ºå¤„ç†   â”‚    â”‚ â€¢ ç»“æœæ”¶é›†å¤„ç†   â”‚    â”‚ â€¢ ç‰ˆæœ¬æ§åˆ¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   ç¼“å­˜å±‚(å¯é€‰)    â”‚
                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚ â€¢ Redis åˆ†å¸ƒå¼   â”‚
                       â”‚ â€¢ Memory æœ¬åœ°    â”‚
                       â”‚ â€¢ äºŒçº§ç¼“å­˜ç­–ç•¥   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰§è¡Œæµç¨‹

1. **è°ƒç”¨** - ä¸šåŠ¡æ–¹è°ƒç”¨ `engine.Exec(ctx, bizCode, input)`
2. **ç¼“å­˜** - æ£€æŸ¥è§„åˆ™ç¼“å­˜ï¼Œæœªå‘½ä¸­åˆ™ä»æ•°æ®åº“åŠ è½½
3. **ç¼–è¯‘** - å°† GRL è§„åˆ™ç¼–è¯‘ä¸ºå¯æ‰§è¡Œçš„çŸ¥è¯†åº“
4. **æ‰§è¡Œ** - æ³¨å…¥ä¸Šä¸‹æ–‡æ•°æ®ï¼Œæ‰§è¡Œè§„åˆ™æ¨ç†
5. **è¿”å›** - æ”¶é›†æ‰§è¡Œç»“æœï¼Œè¿”å›ä¸šåŠ¡æ•°æ®

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
go get gitee.com/damengde/runehammer
```

### æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE runehammer_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    biz_code VARCHAR(100) NOT NULL,           -- ä¸šåŠ¡æ ‡è¯†ç 
    name VARCHAR(200) NOT NULL,               -- è§„åˆ™åç§°  
    grl TEXT NOT NULL,                        -- GRLè§„åˆ™å†…å®¹
    version INT DEFAULT 1,                    -- ç‰ˆæœ¬å·
    enabled BOOLEAN NOT NULL DEFAULT true,   -- æ˜¯å¦å¯ç”¨
    description VARCHAR(500),                 -- è§„åˆ™æè¿°
    created_at DATETIME NOT NULL,             -- åˆ›å»ºæ—¶é—´
    updated_at DATETIME NOT NULL,             -- æ›´æ–°æ—¶é—´
    created_by VARCHAR(100),                  -- åˆ›å»ºè€…
    updated_by VARCHAR(100),                  -- æ›´æ–°è€…
    
    INDEX idx_biz_code (biz_code),
    INDEX idx_enabled (enabled)
);
```

### æœ€å°åŒ–ç¤ºä¾‹

```go
package main

import (
    "context"
    "fmt"
    "gorm.io/driver/mysql"
    "gorm.io/gorm"
    "gitee.com/damengde/runehammer"
)

// å®šä¹‰è¾“å…¥æ•°æ®ç»“æ„
type UserDiscountInput struct {
    User  User  `json:"user"`
    Order Order `json:"order"`
}

type User struct {
    Age  int    `json:"age"`
    VIP  bool   `json:"vip"`
    Name string `json:"name"`
}

type Order struct {
    Amount float64 `json:"amount"`
}

// å®šä¹‰ç»“æœç»“æ„
type DiscountResult struct {
    Discount float64 `json:"discount"`
    Message  string  `json:"message"`
}

func main() {
    // è¿æ¥æ•°æ®åº“
    db, _ := gorm.Open(mysql.Open("user:pass@tcp(localhost:3306)/test?charset=utf8mb4"))
    
    // åˆ›å»ºè§„åˆ™å¼•æ“
    engine, err := runehammer.New[DiscountResult](
        runehammer.WithDB(db),
        runehammer.WithAutoMigrate(),
    )
    if err != nil {
        panic(err)
    }
    defer engine.Close()
    
    // å‡†å¤‡è¾“å…¥æ•°æ®
    input := UserDiscountInput{
        User: User{
            Age:  25,
            VIP:  true,
            Name: "Alice",
        },
        Order: Order{
            Amount: 1000.0,
        },
    }
    
    // æ‰§è¡Œè§„åˆ™
    result, err := engine.Exec(context.Background(), "user_discount", input)
    if err != nil {
        panic(err)
    }
    
    fmt.Printf("æŠ˜æ‰£ç»“æœ: %+v\n", result)
}
```

å¯¹åº”çš„ GRL è§„åˆ™ï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼‰ï¼š

```grl
rule UserVipDiscount "VIPç”¨æˆ·æŠ˜æ‰£è§„åˆ™" salience 100 {
    when
        userdiscountinput.User.VIP == true && userdiscountinput.User.Age >= 18 && userdiscountinput.Order.Amount >= 500
    then
        result["discount"] = 0.8;
        result["message"] = "VIPç”¨æˆ·äº«å—8æŠ˜ä¼˜æƒ ";
        Retract("UserVipDiscount");
}

rule RegularDiscount "æ™®é€šç”¨æˆ·æŠ˜æ‰£è§„åˆ™" salience 50 {
    when
        result["discount"] == nil && userdiscountinput.Order.Amount >= 100
    then
        result["discount"] = 0.9;
        result["message"] = "æ»¡100å…ƒäº«å—9æŠ˜ä¼˜æƒ ";
        Retract("RegularDiscount");
}
```

## ğŸš€ åŠ¨æ€è§„åˆ™å¼•æ“

é™¤äº†ä¼ ç»Ÿçš„æ•°æ®åº“å­˜å‚¨è§„åˆ™æ–¹å¼ï¼ŒRunehammer è¿˜æä¾›äº†åŠ¨æ€è§„åˆ™å¼•æ“ï¼Œæ”¯æŒå®æ—¶ç”Ÿæˆå’Œæ‰§è¡Œè§„åˆ™ï¼Œæ— éœ€é¢„å…ˆå­˜å‚¨ã€‚è¿™å¯¹äºæŒ‡æ ‡è®¡ç®—ã€ä¸´æ—¶è§„åˆ™ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆç­‰åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

- **å®æ—¶æ‰§è¡Œ** - æ— éœ€é¢„å…ˆå­˜å‚¨ï¼Œè§„åˆ™å³æ—¶ç”Ÿæˆå³æ—¶æ‰§è¡Œ
- **å¤šæ ¼å¼æ”¯æŒ** - æ”¯æŒç®€å•è§„åˆ™ã€æ ‡å‡†è§„åˆ™ã€æŒ‡æ ‡è§„åˆ™ç­‰å¤šç§æ ¼å¼
- **è¯­æ³•è½¬æ¢** - æ”¯æŒå°†å¤šç§è¡¨è¾¾å¼è¯­æ³•è½¬æ¢ä¸º GRL
- **å†…å­˜ç¼“å­˜** - è‡ªåŠ¨ç¼“å­˜ç¼–è¯‘ç»“æœï¼Œæå‡é‡å¤æ‰§è¡Œæ•ˆç‡

### åŸºæœ¬ç”¨æ³•

```go
// å®šä¹‰è¾“å…¥æ•°æ®ç»“æ„
type CustomerOrder struct {
    Customer Customer `json:"customer"`
    Order    Order    `json:"order"`
}

type Customer struct {
    Age int `json:"age"`
}

type Order struct {
    Amount float64 `json:"amount"`
}

// å®šä¹‰ç»“æœç»“æ„
type EligibilityResult struct {
    Eligible bool    `json:"eligible"`
    Discount float64 `json:"discount"`
}

// åˆ›å»ºåŠ¨æ€å¼•æ“
dynamicEngine := runehammer.NewDynamicEngine[EligibilityResult](
    runehammer.DynamicEngineConfig{
        EnableCache:       true,
        CacheTTL:          5 * time.Minute,
        StrictValidation:  true,
        ParallelExecution: true,
    },
)

// æ‰§è¡Œç®€å•è§„åˆ™
simpleRule := runehammer.SimpleRule{
    When: "customerorder.Customer.Age >= 18 && customerorder.Order.Amount > 100",
    Then: map[string]string{
        "result.Eligible": "true",
        "result.Discount": "0.1",
    },
}

input := CustomerOrder{
    Customer: Customer{Age: 25},
    Order:    Order{Amount: 150.0},
}

result, err := dynamicEngine.ExecuteRuleDefinition(ctx, simpleRule, input)
// result.Eligible = true
// result.Discount = 0.1
```

### è§„åˆ™ç±»å‹

#### 1. ç®€å•è§„åˆ™ (SimpleRule)
é€‚ç”¨äºå¿«é€Ÿå®šä¹‰ç®€å•çš„æ¡ä»¶-ç»“æœè§„åˆ™ï¼š

```go
rule := runehammer.SimpleRule{
    When: "userinput.User.VIP == true && userinput.Order.Amount > 500",
    Then: map[string]string{
        "result.Priority":     "\"high\"",
        "result.FreeShipping": "true",
    },
}
```

#### 2. æŒ‡æ ‡è§„åˆ™ (MetricRule)
ä¸“é—¨ç”¨äºæŒ‡æ ‡è®¡ç®—å’Œæ•°æ®åˆ†æï¼š

```go
metricRule := runehammer.MetricRule{
    Name:        "customer_score",
    Description: "å®¢æˆ·è¯„åˆ†è®¡ç®—",
    Formula:     "age_score + income_score + credit_score",
    Variables: map[string]string{
        "age_score":    "customerdata.Age * 0.1",
        "income_score": "customerdata.Income * 0.0001",
        "credit_score": "customerdata.Credit / 10",
    },
    Conditions: []string{
        "customerdata.Age >= 18",
        "customerdata.Income > 0",
    },
}

result, err := dynamicEngine.ExecuteRuleDefinition(ctx, metricRule, input)
// result.CustomerScore = è®¡ç®—åçš„è¯„åˆ†
```

#### 3. æ ‡å‡†è§„åˆ™ (StandardRule)
å®Œæ•´çš„è§„åˆ™å®šä¹‰æ ¼å¼ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶å’Œå¤šç§åŠ¨ä½œï¼š

```go
standardRule := runehammer.StandardRule{
    ID:          "loan_approval",
    Name:        "è´·æ¬¾å®¡æ‰¹è§„åˆ™",
    Description: "æ ¹æ®å®¢æˆ·ä¿¡æ¯è¿›è¡Œè´·æ¬¾å®¡æ‰¹",
    Priority:    100,
    Enabled:     true,
    Tags:        []string{"loan", "approval"},
    Conditions: runehammer.Condition{
        Type:     "composite",
        Operator: "and",
        Children: []runehammer.Condition{
            {
                Type:     "simple",
                Left:     "loanapplication.Customer.Age",
                Operator: ">=",
                Right:    22,
            },
            {
                Type:     "simple",
                Left:     "loanapplication.Customer.CreditScore",
                Operator: ">=",
                Right:    650,
            },
        },
    },
    Actions: []runehammer.Action{
        {
            Type:   "assign",
            Target: "result.approved",
            Value:  true,
        },
        {
            Type:       "calculate",
            Target:     "result.LoanAmount",
            Expression: "loanapplication.Customer.Income * 5",
        },
    },
}
```

### å¤šè¯­æ³•è¡¨è¾¾å¼è§£æ

åŠ¨æ€å¼•æ“æ”¯æŒå¤šç§è¡¨è¾¾å¼è¯­æ³•ï¼Œå¯ä»¥æ ¹æ®æ¥æºç³»ç»Ÿé€‰æ‹©åˆé€‚çš„è¯­æ³•ï¼š

#### SQL-like è¯­æ³•
```go
parser := runehammer.NewExpressionParser(runehammer.SyntaxTypeSQL)
// "age >= 18 AND income > 30000"
// è½¬æ¢ä¸º: "age >= 18 && income > 30000"
```

#### JavaScript-like è¯­æ³•
```go
parser := runehammer.NewExpressionParser(runehammer.SyntaxTypeJavaScript)
// "orders.filter(o => o.amount > 100).length > 0"
// è½¬æ¢ä¸º: "Count(Filter(orders, \"amount > 100\")) > 0"
```

### æ‰¹é‡æ‰§è¡Œ

æ”¯æŒæ‰¹é‡æ‰§è¡Œå¤šä¸ªè§„åˆ™ï¼Œæå‡å¤„ç†æ•ˆç‡ï¼š

```go
rules := []interface{}{
    runehammer.SimpleRule{
        When: "order.amount > 100",
        Then: map[string]string{"result.discount": "0.05"},
    },
    runehammer.SimpleRule{
        When: "customer.vip == true",
        Then: map[string]string{"result.vip_bonus": "50"},
    },
}

results, err := dynamicEngine.ExecuteBatch(ctx, rules, input)
// results[0] = ç¬¬ä¸€ä¸ªè§„åˆ™çš„ç»“æœ
// results[1] = ç¬¬äºŒä¸ªè§„åˆ™çš„ç»“æœ
```

### è‡ªå®šä¹‰å‡½æ•°

åŠ¨æ€å¼•æ“æ”¯æŒæ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ï¼š

```go
// æ³¨å†Œå•ä¸ªå‡½æ•°
dynamicEngine.RegisterCustomFunction("CalculateDiscount", func(amount float64, rate float64) float64 {
    return amount * rate
})

// æ‰¹é‡æ³¨å†Œå‡½æ•°
dynamicEngine.RegisterCustomFunctions(map[string]interface{}{
    "ValidateEmail": func(email string) bool {
        // é‚®ç®±éªŒè¯é€»è¾‘
        return true
    },
    "GetRegionCode": func(address string) string {
        // åœ°åŒºç¼–ç è·å–é€»è¾‘
        return "CN-GD"
    },
})

// åœ¨è§„åˆ™ä¸­ä½¿ç”¨
rule := runehammer.SimpleRule{
    When: "ValidateEmail(Params.customer.email) && Params.order.amount > 0",
    Then: map[string]string{
        "result.discount": "CalculateDiscount(Params.order.amount, 0.1)",
        "result.region":   "GetRegionCode(Params.customer.address)",
    },
}
```

## ğŸ“– è¯¦ç»†ä½¿ç”¨

### é…ç½®é€‰é¡¹

#### æ•°æ®åº“å¼•æ“é…ç½®
```go
engine, err := runehammer.New[YourResultType](
    // æ•°æ®åº“é…ç½®
    runehammer.WithDB(db),                                    // ä½¿ç”¨ç°æœ‰æ•°æ®åº“è¿æ¥
    runehammer.WithDSN("user:pass@tcp(localhost:3306)/db"),  // æˆ–ä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²
    runehammer.WithAutoMigrate(),                             // è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
    runehammer.WithTableName("custom_rules"),                // è‡ªå®šä¹‰è¡¨å
    
    // ç¼“å­˜é…ç½®
    runehammer.WithRedis("localhost:6379", "", 0),           // Redisç¼“å­˜
    runehammer.WithCache(customCache),                        // è‡ªå®šä¹‰ç¼“å­˜å®ç°
    runehammer.WithCacheTTL(10*time.Minute),                 // ç¼“å­˜è¿‡æœŸæ—¶é—´
    runehammer.WithMaxCacheSize(1000),                       // å†…å­˜ç¼“å­˜å¤§å°
    runehammer.WithDisableCache(),                            // ç¦ç”¨ç¼“å­˜
    
    // å…¶ä»–é…ç½®
    runehammer.WithLogger(logger),                           // è‡ªå®šä¹‰æ—¥å¿—å™¨
    runehammer.WithSyncInterval(5*time.Minute),             // åŒæ­¥é—´éš”
)
```

#### åŠ¨æ€å¼•æ“é…ç½®
```go
dynamicEngine := runehammer.NewDynamicEngine[ResultType](
    runehammer.DynamicEngineConfig{
        // åŸºç¡€é…ç½®
        EnableCache:       true,              // å¯ç”¨ç¼“å­˜
        CacheTTL:          5 * time.Minute,   // ç¼“å­˜è¿‡æœŸæ—¶é—´
        MaxCacheSize:      100,               // æœ€å¤§ç¼“å­˜å¤§å°
        StrictValidation:  true,              // ä¸¥æ ¼éªŒè¯
        ParallelExecution: true,              // æ”¯æŒå¹¶è¡Œæ‰§è¡Œ
        DefaultTimeout:    30 * time.Second,  // é»˜è®¤è¶…æ—¶æ—¶é—´
    },
)

// æˆ–ä½¿ç”¨å®Œæ•´é…ç½®é€‰é¡¹
engine, err := runehammer.New[YourResultType](
    // åŠ¨æ€é…ç½®
    runehammer.WithDynamicConfig(&runehammer.DynamicConfig{
        // è½¬æ¢å™¨é…ç½®
        ConverterConfig: runehammer.ConverterConfig{
            StrictMode:      false,
            DefaultPriority: 50,
            VariablePrefix: map[string]string{
                "user":     "user",
                "order":    "order",
                "customer": "customer",
            },
        },
        
        // è§£æå™¨é…ç½®
        ParserConfig: runehammer.ParserConfig{
            DefaultSyntax: runehammer.SyntaxTypeSQL,
            SupportedSyntax: []runehammer.SyntaxType{
                runehammer.SyntaxTypeSQL,
                runehammer.SyntaxTypeJavaScript,
            },
        },
        
        // æ‰§è¡Œé…ç½®
        ExecutionConfig: runehammer.ExecutionConfig{
            EnableParallel:   true,
            MaxConcurrency:   10,
            ExecutionTimeout: 30 * time.Second,
            MaxRules:         100,
        },
    }),
    
    // å¿«é€Ÿé…ç½®é€‰é¡¹
    runehammer.WithDefaultSyntax(runehammer.SyntaxTypeSQL),
    runehammer.WithMaxConcurrency(10),
    runehammer.WithExecutionTimeout(30 * time.Second),
    runehammer.WithCustomFunctions(map[string]interface{}{
        "CustomFunc": func(x int) int { return x * 2 },
    }),
)
```

### ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹

#### 1. å®¢æˆ·åˆ†çº§è§„åˆ™

```go
// å®¢æˆ·æ•°æ®ç»“æ„
type CustomerRatingInput struct {
    Customer Customer `json:"customer"`
}

type Customer struct {
    ID          string  `json:"id"`
    Age         int     `json:"age"`
    Income      float64 `json:"income"`
    CreditScore int     `json:"credit_score"`
}

// æ‰§è¡Œå®¢æˆ·åˆ†çº§
input := CustomerRatingInput{
    Customer: Customer{
        ID:          "C001",
        Age:         35,
        Income:      80000,
        CreditScore: 750,
    },
}

result, err := engine.Exec(ctx, "customer_rating", input)
// result["level"] = "Gold"
// result["credit_limit"] = 50000
```

å¯¹åº”çš„ GRL è§„åˆ™ï¼š

```grl
rule GoldCustomer "é»„é‡‘å®¢æˆ·è¯„çº§" salience 100 {
    when
        customerratinginput.Customer.Age >= 25 && 
        customerratinginput.Customer.Income >= 50000 && 
        customerratinginput.Customer.CreditScore >= 700
    then
        result["level"] = "Gold";
        result["credit_limit"] = 50000;
        result["benefits"] = ["ä¸“å±å®¢æœ", "ä¼˜å…ˆæ”¾æ¬¾", "è´¹ç‡ä¼˜æƒ "];
}

rule SilverCustomer "ç™½é“¶å®¢æˆ·è¯„çº§" salience 80 {
    when
        customerratinginput.Customer.Age >= 22 && 
        customerratinginput.Customer.Income >= 30000 && 
        customerratinginput.Customer.CreditScore >= 600
    then
        result["level"] = "Silver";
        result["credit_limit"] = 20000;
        result["benefits"] = ["åœ¨çº¿å®¢æœ", "æ ‡å‡†æ”¾æ¬¾"];
}
```

#### 2. è®¢å•å¤„ç†è§„åˆ™

```go
// è®¢å•å¤„ç†ç»“æ„
type OrderProcessingInput struct {
    Order     Order     `json:"order"`
    Inventory Inventory `json:"inventory"`
}

type Order struct {
    Amount       float64 `json:"amount"`
    CustomerType string  `json:"customer_type"`
    Region       string  `json:"region"`
    Urgent       bool    `json:"urgent"`
}

type Inventory struct {
    Stock    int `json:"stock"`
    Reserved int `json:"reserved"`
}

// è®¢å•å¤„ç†
input := OrderProcessingInput{
    Order: Order{
        Amount:       1200.0,
        CustomerType: "VIP",
        Region:       "åä¸œ",
        Urgent:       true,
    },
    Inventory: Inventory{
        Stock:    100,
        Reserved: 20,
    },
}

result, err := engine.Exec(ctx, "order_processing", input)
// result["processing_time"] = "2å°æ—¶"
// result["shipping_cost"] = 0
// result["priority"] = "é«˜"
```

## ğŸ“Š å†…ç½®å‡½æ•°å‚è€ƒ

Runehammer æä¾›äº† 50+ å†…ç½®å‡½æ•°ï¼Œæ¶µç›–å„ç§å¸¸ç”¨åœºæ™¯ï¼š

### æ•°å­¦å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `Abs(x)` | ç»å¯¹å€¼ | `Abs(-10)` â†’ `10` |
| `Max(a, b)` | æœ€å¤§å€¼ | `Max(5, 10)` â†’ `10` |
| `Min(a, b)` | æœ€å°å€¼ | `Min(5, 10)` â†’ `5` |
| `Round(x)` | å››èˆäº”å…¥ | `Round(3.7)` â†’ `4` |
| `Floor(x)` | å‘ä¸‹å–æ•´ | `Floor(3.7)` â†’ `3` |
| `Ceil(x)` | å‘ä¸Šå–æ•´ | `Ceil(3.2)` â†’ `4` |
| `Pow(x, y)` | å¹‚è¿ç®— | `Pow(2, 3)` â†’ `8` |
| `Sqrt(x)` | å¹³æ–¹æ ¹ | `Sqrt(16)` â†’ `4` |
| `Sin(x)` | æ­£å¼¦ | `Sin(0)` â†’ `0` |
| `Cos(x)` | ä½™å¼¦ | `Cos(0)` â†’ `1` |
| `Tan(x)` | æ­£åˆ‡ | `Tan(0)` â†’ `0` |
| `Log(x)` | è‡ªç„¶å¯¹æ•° | `Log(2.718)` â†’ `1` |
| `Log10(x)` | ä»¥10ä¸ºåº•çš„å¯¹æ•° | `Log10(100)` â†’ `2` |

### ç»Ÿè®¡å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `Sum(values)` | æ±‚å’Œ | `Sum([1,2,3,4])` â†’ `10` |
| `Avg(values)` | å¹³å‡å€¼ | `Avg([1,2,3,4])` â†’ `2.5` |
| `MaxSlice(values)` | æ•°ç»„æœ€å¤§å€¼ | `MaxSlice([1,5,3])` â†’ `5` |
| `MinSlice(values)` | æ•°ç»„æœ€å°å€¼ | `MinSlice([1,5,3])` â†’ `1` |

### å­—ç¬¦ä¸²å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `Contains(s, substr)` | åŒ…å«æ£€æŸ¥ | `Contains("hello", "ell")` â†’ `true` |
| `HasPrefix(s, prefix)` | å‰ç¼€æ£€æŸ¥ | `HasPrefix("hello", "he")` â†’ `true` |
| `HasSuffix(s, suffix)` | åç¼€æ£€æŸ¥ | `HasSuffix("hello", "lo")` â†’ `true` |
| `Len(s)` | å­—ç¬¦ä¸²é•¿åº¦ | `Len("hello")` â†’ `5` |
| `ToUpper(s)` | è½¬å¤§å†™ | `ToUpper("hello")` â†’ `"HELLO"` |
| `ToLower(s)` | è½¬å°å†™ | `ToLower("HELLO")` â†’ `"hello"` |
| `Split(s, sep)` | å­—ç¬¦ä¸²åˆ†å‰² | `Split("a,b,c", ",")` â†’ `["a","b","c"]` |
| `Join(elems, sep)` | å­—ç¬¦ä¸²è¿æ¥ | `Join(["a","b"], ",")` â†’ `"a,b"` |
| `Replace(s, old, new, n)` | å­—ç¬¦ä¸²æ›¿æ¢ | `Replace("hello", "l", "L", 1)` â†’ `"heLlo"` |
| `TrimSpace(s)` | å»é™¤ç©ºç™½ | `TrimSpace(" hello ")` â†’ `"hello"` |

### æ—¶é—´å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `Now()` | å½“å‰æ—¶é—´ | `Now()` |
| `Today()` | ä»Šå¤©å¼€å§‹æ—¶é—´ | `Today()` |
| `NowMillis()` | å½“å‰æ¯«ç§’æ—¶é—´æˆ³ | `NowMillis()` |
| `TimeToMillis(t)` | æ—¶é—´è½¬æ¯«ç§’æ—¶é—´æˆ³ | `TimeToMillis(Now())` |
| `MillisToTime(millis)` | æ¯«ç§’æ—¶é—´æˆ³è½¬æ—¶é—´ | `MillisToTime(1699123200000)` |
| `FormatTime(t, layout)` | æ ¼å¼åŒ–æ—¶é—´ | `FormatTime(Now(), "2006-01-02")` |
| `ParseTime(layout, value)` | è§£ææ—¶é—´ | `ParseTime("2006-01-02", "2023-12-01")` |
| `AddDays(t, days)` | åŠ å‡å¤©æ•° | `AddDays(Today(), 7)` |
| `AddHours(t, hours)` | åŠ å‡å°æ—¶ | `AddHours(Now(), -2)` |

### éªŒè¯å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `Matches(s, pattern)` | æ­£åˆ™åŒ¹é… | `Matches("abc123", "\\d+")` â†’ `true` |
| `IsEmail(email)` | é‚®ç®±éªŒè¯ | `IsEmail("test@example.com")` â†’ `true` |
| `IsPhoneNumber(phone)` | æ‰‹æœºå·éªŒè¯ | `IsPhoneNumber("13800138000")` â†’ `true` |
| `IsIDCard(id)` | èº«ä»½è¯éªŒè¯ | `IsIDCard("110101199001011234")` â†’ `true` |
| `Between(value, min, max)` | èŒƒå›´æ£€æŸ¥ | `Between(5, 1, 10)` â†’ `true` |
| `LengthBetween(s, min, max)` | é•¿åº¦æ£€æŸ¥ | `LengthBetween("hello", 3, 10)` â†’ `true` |

### ç±»å‹è½¬æ¢å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ToString(v)` | è½¬å­—ç¬¦ä¸² | `ToString(123)` â†’ `"123"` |
| `ToInt(s)` | è½¬æ•´æ•° | `ToInt("123")` â†’ `123` |
| `ToFloat(s)` | è½¬æµ®ç‚¹æ•° | `ToFloat("3.14")` â†’ `3.14` |
| `ToBool(s)` | è½¬å¸ƒå°”å€¼ | `ToBool("true")` â†’ `true` |

### å·¥å…·å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `IsEmpty(v)` | ç©ºå€¼æ£€æŸ¥ | `IsEmpty("")` â†’ `true` |
| `IsNotEmpty(v)` | éç©ºæ£€æŸ¥ | `IsNotEmpty("hello")` â†’ `true` |
| `IF(condition, trueVal, falseVal)` | æ¡ä»¶è¡¨è¾¾å¼ | `IF(age >= 18, "æˆå¹´", "æœªæˆå¹´")` |

### é›†åˆå‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ContainsSlice(slice, item)` | æ•°ç»„åŒ…å« | `ContainsSlice([1,2,3], 2)` â†’ `true` |
| `Count(slice)` | æ•°ç»„é•¿åº¦ | `Count([1,2,3])` â†’ `3` |
| `Unique(slice)` | æ•°ç»„å»é‡ | `Unique([1,2,2,3])` â†’ `[1,2,3]` |

### åœ¨è§„åˆ™ä¸­ä½¿ç”¨å†…ç½®å‡½æ•°

```grl
rule MathExample "æ•°å­¦å‡½æ•°ç¤ºä¾‹" salience 100 {
    when
        Abs(customerinput.Customer.Balance) > 1000 &&
        Between(customerinput.Customer.Age, 18, 65)
    then
        result["credit_score"] = Round(customerinput.Customer.Income * 0.001);
        result["risk_level"] = IF(customerinput.Customer.DebtRatio > 0.5, "é«˜", "ä½");
}

rule StringExample "å­—ç¬¦ä¸²å‡½æ•°ç¤ºä¾‹" salience 90 {
    when
        Contains(customerinput.Customer.Email, "@") &&
        LengthBetween(customerinput.Customer.Name, 2, 50)
    then
        result["email_valid"] = IsEmail(customerinput.Customer.Email);
        result["name_upper"] = ToUpper(customerinput.Customer.Name);
}

rule TimeExample "æ—¶é—´å‡½æ•°ç¤ºä¾‹" salience 80 {
    when
        customerinput.Customer.LastLogin != nil
    then
        result["days_inactive"] = (Now().Unix() - customerinput.Customer.LastLogin.Unix()) / 86400;
        result["is_active"] = result["days_inactive"] <= 30;
        result["current_millis"] = NowMillis();
        result["login_millis"] = TimeToMillis(customerinput.Customer.LastLogin);
}
```

## ğŸ“‹ å˜é‡æ³¨å…¥è§„åˆ™

Runehammeråœ¨æ‰§è¡Œè§„åˆ™æ—¶ï¼Œä¼šå°†è¾“å…¥æ•°æ®æŒ‰ç…§ä»¥ä¸‹è§„åˆ™æ³¨å…¥åˆ°è§„åˆ™æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼š

### ğŸ”¤ æ³¨å…¥è§„åˆ™

| è¾“å…¥æ•°æ®ç±»å‹ | æ³¨å…¥æ–¹å¼ | è§„åˆ™ä¸­è®¿é—®æ–¹å¼ | ç¤ºä¾‹ |
|-------------|----------|---------------|------|
| **Mapç±»å‹ï¼ˆä»…æ•°æ®åº“å¼•æ“ï¼‰** | ä½œä¸ºæ•´ä½“æ³¨å…¥ä¸º`Params` | `Params.é”®å` | `Params.customer.age`ã€`Params.order.amount` |
| **ç»“æ„ä½“ç±»å‹** | ä½¿ç”¨ç±»å‹åï¼ˆå°å†™ï¼‰| `ç±»å‹å.å­—æ®µ` | `user.name`ã€`product.price` |
| **åŒ¿åç»“æ„ä½“** | ç»Ÿä¸€ä½¿ç”¨`Params` | `Params.å­—æ®µ` | `Params.value`ã€`Params.data` |
| **å…¶ä»–ç±»å‹** | ç»Ÿä¸€ä½¿ç”¨`Params` | ç›´æ¥è®¿é—®`Params` | `Params > 100`ã€`Params == "test"` |

### ğŸ” è¯¦ç»†è¯´æ˜

#### 1. Mapç±»å‹æ•°æ®æ³¨å…¥ï¼ˆä»…æ•°æ®åº“å¼•æ“æ”¯æŒï¼‰
```go
// æ•°æ®åº“å¼•æ“mapç±»å‹ç¤ºä¾‹ï¼ˆåŠ¨æ€å¼•æ“ä¸æ”¯æŒmapç±»å‹ï¼‰
type CustomerOrderInput struct {
    Customer CustomerInfo `json:"customer"`
    Order    OrderInfo    `json:"order"`
}

type CustomerInfo struct {
    Age int  `json:"age"`
    VIP bool `json:"vip"`
}

type OrderInfo struct {
    Amount int    `json:"amount"`
    Status string `json:"status"`
}

// ä½¿ç”¨ç»“æ„ä½“ä½œä¸ºè¾“å…¥
input := CustomerOrderInput{
    Customer: CustomerInfo{Age: 25, VIP: true},
    Order:    OrderInfo{Amount: 1500, Status: "paid"},
}

// è§„åˆ™ä¸­è®¿é—®ç»“æ„ä½“å­—æ®µ
rule CustomerVip "VIPå®¢æˆ·åˆ¤æ–­" {
    when
        customerorderinput.Customer.Age >= 18 && customerorderinput.Customer.VIP == true && customerorderinput.Order.Amount > 1000
    then
        result["level"] = "VIP";
}
```

#### 2. ç»“æ„ä½“ç±»å‹æ•°æ®æ³¨å…¥
```go
// å®šä¹‰ç»“æ„ä½“
type Customer struct {
    Age  int    `json:"age"`
    Name string `json:"name"`
    VIP  bool   `json:"vip"`
}

// è¾“å…¥æ•°æ®
customer := Customer{Age: 25, Name: "å¼ ä¸‰", VIP: true}

// è§„åˆ™ä¸­ä½¿ç”¨ç±»å‹åï¼ˆå°å†™ï¼‰è®¿é—®
rule CheckCustomer "æ£€æŸ¥å®¢æˆ·" {
    when
        customer.Age >= 18 && customer.VIP == true
    then
        result["eligible"] = true;
        result["message"] = customer.Name + " ç¬¦åˆæ¡ä»¶";
}
```

#### 3. åŒ¿åç»“æ„ä½“å’Œå…¶ä»–ç±»å‹
```go
// åŒ¿åç»“æ„ä½“
input := struct {
    Value int
    Flag  bool
}{Value: 100, Flag: true}

// æˆ–è€…åŸºæœ¬ç±»å‹
input := 100

// è§„åˆ™ä¸­ä½¿ç”¨Paramsè®¿é—®
rule CheckValue "æ£€æŸ¥å€¼" {
    when
        Params.Value > 50 && Params.Flag == true
        // æˆ–å¯¹äºåŸºæœ¬ç±»å‹: Params > 50
    then
        result["valid"] = true;
}
```

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å˜é‡åå¤§å°å†™**ï¼šç»“æ„ä½“ç±»å‹åä¼šè½¬æ¢ä¸ºå°å†™ä½œä¸ºå˜é‡å
2. **ç»Ÿä¸€è®¿é—®æ–¹å¼**ï¼šé™¤ç»“æ„ä½“ç±»å‹å¤–ï¼Œæ‰€æœ‰å…¶ä»–ç±»å‹éƒ½é€šè¿‡`Params`è®¿é—®
3. **ä¿ç•™å­—æ®µ**ï¼šé¿å…ä½¿ç”¨`result`ä½œä¸ºè¾“å…¥å­—æ®µåï¼Œè¿™æ˜¯è¾“å‡ºç»“æœçš„ä¿ç•™å­—æ®µ
4. **ç±»å‹å®‰å…¨**ï¼šåœ¨è§„åˆ™ä¸­è®¿é—®å­—æ®µæ—¶ï¼Œè¯·ç¡®ä¿å­—æ®µå­˜åœ¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ‰§è¡Œé”™è¯¯

## ğŸ“š API æ–‡æ¡£

### Engine æ¥å£

```go
type Engine[T any] interface {
    // æ‰§è¡Œè§„åˆ™
    Exec(ctx context.Context, bizCode string, input any) (T, error)
    
    // å…³é—­å¼•æ“ï¼Œé‡Šæ”¾èµ„æº
    Close() error
}
```

### é…ç½®é€‰é¡¹

#### æ•°æ®åº“å¼•æ“é…ç½®é€‰é¡¹
| é€‰é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `WithDB(db)` | ä½¿ç”¨ç°æœ‰GORMæ•°æ®åº“è¿æ¥ | `WithDB(gormDB)` |
| `WithDSN(dsn)` | ä½¿ç”¨æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² | `WithDSN("user:pass@tcp(host)/db")` |
| `WithAutoMigrate()` | è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ | `WithAutoMigrate()` |
| `WithTableName(name)` | è‡ªå®šä¹‰è§„åˆ™è¡¨å | `WithTableName("my_rules")` |
| `WithRedis(addr, pass, db)` | é…ç½®Redisç¼“å­˜ | `WithRedis("localhost:6379", "", 0)` |
| `WithCache(cache)` | ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜å®ç° | `WithCache(myCache)` |
| `WithCacheTTL(ttl)` | è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ | `WithCacheTTL(10*time.Minute)` |
| `WithLogger(logger)` | è®¾ç½®è‡ªå®šä¹‰æ—¥å¿—å™¨ | `WithLogger(myLogger)` |

#### åŠ¨æ€å¼•æ“é…ç½®é€‰é¡¹
| é€‰é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `WithDynamicConfig(config)` | è®¾ç½®å®Œæ•´åŠ¨æ€é…ç½® | `WithDynamicConfig(dynamicConfig)` |
| `WithConverterConfig(config)` | è®¾ç½®è½¬æ¢å™¨é…ç½® | `WithConverterConfig(converterConfig)` |
| `WithParserConfig(config)` | è®¾ç½®è§£æå™¨é…ç½® | `WithParserConfig(parserConfig)` |
| `WithExecutionConfig(config)` | è®¾ç½®æ‰§è¡Œé…ç½® | `WithExecutionConfig(execConfig)` |
| `WithDefaultSyntax(syntax)` | è®¾ç½®é»˜è®¤è¯­æ³•ç±»å‹ | `WithDefaultSyntax(SyntaxTypeSQL)` |
| `WithSupportedSyntax(syntaxes...)` | è®¾ç½®æ”¯æŒçš„è¯­æ³•ç±»å‹ | `WithSupportedSyntax(SQL, JS)` |
| `WithCustomOperators(ops)` | è®¾ç½®è‡ªå®šä¹‰æ“ä½œç¬¦ | `WithCustomOperators(operators)` |
| `WithCustomFunctions(funcs)` | è®¾ç½®è‡ªå®šä¹‰å‡½æ•° | `WithCustomFunctions(functions)` |
| `WithMaxConcurrency(max)` | è®¾ç½®æœ€å¤§å¹¶å‘æ•° | `WithMaxConcurrency(10)` |
| `WithExecutionTimeout(timeout)` | è®¾ç½®æ‰§è¡Œè¶…æ—¶æ—¶é—´ | `WithExecutionTimeout(30*time.Second)` |

### é”™è¯¯å¤„ç†

```go
result, err := engine.Exec(ctx, bizCode, input)
if err != nil {
    switch {
    case strings.Contains(err.Error(), "è§„åˆ™æœªæ‰¾åˆ°"):
        // å¤„ç†è§„åˆ™ä¸å­˜åœ¨çš„æƒ…å†µ
    case strings.Contains(err.Error(), "ç¼–è¯‘å¤±è´¥"):
        // å¤„ç†è§„åˆ™è¯­æ³•é”™è¯¯
    case strings.Contains(err.Error(), "æ‰§è¡Œå¤±è´¥"):
        // å¤„ç†è§„åˆ™æ‰§è¡Œé”™è¯¯
    default:
        // å…¶ä»–é”™è¯¯
    }
}
```

## ğŸ”§ é«˜çº§ç‰¹æ€§

### ç¼“å­˜ç­–ç•¥

```go
// å•ä¸€ç¼“å­˜ç­–ç•¥ - å¯åŠ¨æ—¶ç¡®å®š
engine, _ := runehammer.New[ResultType](
    // é€‰æ‹©Redisç¼“å­˜
    runehammer.WithRedis("localhost:6379", "", 0),
    runehammer.WithCacheTTL(30*time.Minute),        // 30åˆ†é’Ÿè¿‡æœŸ
)

// æˆ–é€‰æ‹©å†…å­˜ç¼“å­˜
engine, _ := runehammer.New[ResultType](
    runehammer.WithMaxCacheSize(1000),              // æœ€å¤§1000æ¡è§„åˆ™
    runehammer.WithCacheTTL(30*time.Minute),
)

// æˆ–å®Œå…¨ç¦ç”¨ç¼“å­˜
engine, _ := runehammer.New[ResultType](
    runehammer.WithDisableCache(),
)
```

### æ—¥å¿—é›†æˆ

```go
// å®ç°Loggeræ¥å£
type MyLogger struct {
    logger *zap.Logger
}

func (l *MyLogger) Debugf(ctx context.Context, msg string, keyvals ...any) {
    l.logger.Debug(msg, zap.Any("data", keyvals))
}
// ... å®ç°å…¶ä»–æ–¹æ³•

// ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—
engine, _ := runehammer.New[ResultType](
    runehammer.WithLogger(&MyLogger{logger: zapLogger}),
)
```

### è‡ªå®šä¹‰å‡½æ•°æ³¨å…¥

#### æ•°æ®åº“å¼•æ“
å½“å‰ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹å†…ç½®å‡½æ•°ï¼š

- `Now()` - è·å–å½“å‰æ—¶é—´
- `DaysBetween(date1, date2)` - è®¡ç®—æ—¥æœŸå·®
- `Contains(str, substr)` - å­—ç¬¦ä¸²åŒ…å«æ£€æŸ¥
- `Len(obj)` - è·å–é•¿åº¦
- `Max(a, b)` / `Min(a, b)` - æœ€å¤§å€¼/æœ€å°å€¼

åœ¨ GRL è§„åˆ™ä¸­ä½¿ç”¨ï¼š

```grl
rule TimeBasedRule "åŸºäºæ—¶é—´çš„è§„åˆ™" {
    when
        DaysBetween(user.last_login, Now()) > 30
    then
        result["action"] = "send_recall_email";
}
```

#### åŠ¨æ€å¼•æ“
åŠ¨æ€å¼•æ“æ”¯æŒ 50+ å†…ç½®å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ï¼š

```go
// åˆ›å»ºåŠ¨æ€å¼•æ“
dynamicEngine := runehammer.NewDynamicEngine[CustomResult](
    runehammer.DynamicEngineConfig{
        EnableCache: true,
        CacheTTL:    5 * time.Minute,
    },
)

// æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
dynamicEngine.RegisterCustomFunction("CalculateScore", func(income, age, credit int) float64 {
    return float64(income)*0.001 + float64(age)*0.1 + float64(credit)*0.01
})

dynamicEngine.RegisterCustomFunctions(map[string]interface{}{
    "ValidateIDCard": func(id string) bool {
        // èº«ä»½è¯éªŒè¯é€»è¾‘
        return len(id) == 18
    },
    "GetCityCode": func(address string) string {
        // æ ¹æ®åœ°å€è·å–åŸå¸‚ä»£ç 
        if strings.Contains(address, "åŒ—äº¬") {
            return "010"
        }
        return "000"
    },
})

metricRule := runehammer.MetricRule{
    Name:        "comprehensive_score",
    Description: "ç»¼åˆè¯„åˆ†è®¡ç®—",
    Formula:     "CalculateScore(customerscoeinput.Customer.Income, customerscoeinput.Customer.Age, customerscoeinput.Customer.Credit)",
    Conditions: []string{
        "ValidateIDCard(customerscoeinput.Customer.IDCard)",
        "customerscoeinput.Customer.Income > 0",
    },
}

// è¾“å…¥æ•°æ®ç»“æ„
type CustomerScoreInput struct {
    Customer CustomerDetails `json:"customer"`
}

type CustomerDetails struct {
    Income  int    `json:"income"`
    Age     int    `json:"age"`
    Credit  int    `json:"credit"`
    IDCard  string `json:"id_card"`
    Address string `json:"address"`
}

input := CustomerScoreInput{
    Customer: CustomerDetails{
        Income:  80000,
        Age:     30,
        Credit:  750,
        IDCard:  "110101199001011234",
        Address: "åŒ—äº¬å¸‚æœé˜³åŒº",
    },
}

result, err := dynamicEngine.ExecuteRuleDefinition(ctx, rule, input)
// result.ComprehensiveScore = 88.5 (è®¡ç®—ç»“æœ)
```

### è§„åˆ™è½¬æ¢å™¨

åŠ¨æ€å¼•æ“å†…ç½®è§„åˆ™è½¬æ¢å™¨ï¼Œæ”¯æŒå¤šç§æ ¼å¼äº’è½¬ï¼š

```go
converter := runehammer.NewGRLConverter()

// ä» JSON è½¬æ¢ä¸ºç»“æ„ä½“çš„ç¤ºä¾‹
jsonRule := `{
    "when": "customerinput.Customer.Age >= 18 && orderinput.Order.Amount > 100",
    "then": {
        "result.eligible": "true",
        "result.discount": "0.1"
    }
}`

grl, err := converter.ConvertToGRL(jsonRule)
// ç”Ÿæˆæ ‡å‡†çš„ GRL è§„åˆ™

// ä»æ ‡å‡†è§„åˆ™è½¬æ¢
standardRule := runehammer.StandardRule{
    ID:          "approval_rule",
    Name:        "å®¡æ‰¹è§„åˆ™",
    Description: "è‡ªåŠ¨å®¡æ‰¹é€»è¾‘",
    Priority:    100,
    Conditions: runehammer.Condition{
        Type:     "simple",
        Left:     "applicationinput.Application.Score",
        Operator: ">=",
        Right:    700,
    },
    Actions: []runehammer.Action{
        {
            Type:   "assign",
            Target: "result.approved",
            Value:  true,
        },
    },
}

grl, err = converter.ConvertRule(standardRule, runehammer.Definitions{})
```

### å¤šè¯­æ³•æ”¯æŒç¤ºä¾‹

```go
parser := runehammer.NewExpressionParser()

// SQL è¯­æ³•è½¬æ¢ - ä½¿ç”¨ç»“æ„ä½“å­—æ®µ
parser.SetSyntax(runehammer.SyntaxTypeSQL)
condition, _ := parser.ParseCondition("userinput.User.Age >= 18 AND userinput.User.Income BETWEEN 30000 AND 100000")
// è¾“å‡º: "userinput.User.Age >= 18 && userinput.User.Income >= 30000 && userinput.User.Income <= 100000"

// JavaScript è¯­æ³•è½¬æ¢ - ä½¿ç”¨ç»“æ„ä½“å­—æ®µ
parser.SetSyntax(runehammer.SyntaxTypeJavaScript)
condition, _ = parser.ParseCondition("orderinput.Orders.filter(o => o.amount > 100).length > 0")
// è¾“å‡º: "Count(Filter(orderinput.Orders, \"amount > 100\")) > 0"
```

### æ‰¹é‡è§„åˆ™æ‰§è¡Œ

```go
// å®šä¹‰å¤šä¸ªä¸åŒç±»å‹çš„è§„åˆ™
rules := []interface{}{
    // ç®€å•è§„åˆ™
    runehammer.SimpleRule{
        When: "batchexampleinput.Order.Amount > 500",
        Then: map[string]string{
            "result.FreeShipping": "true",
        },
    },
    
    // æŒ‡æ ‡è§„åˆ™
    runehammer.MetricRule{
        Name:    "loyalty_score",
        Formula: "purchase_count * 10 + total_amount * 0.01",
        Variables: map[string]string{
            "purchase_count": "batchexampleinput.Customer.PurchaseCount",
            "total_amount":   "batchexampleinput.Customer.TotalAmount",
        },
    },
    
    // æ ‡å‡†è§„åˆ™
    runehammer.StandardRule{
        ID:   "vip_check",
        Name: "VIPæ£€æŸ¥",
        Conditions: runehammer.Condition{
            Type:     "simple",
            Left:     "batchexampleinput.Customer.VipLevel",
            Operator: ">=",
            Right:    3,
        },
        Actions: []runehammer.Action{
            {
                Type:   "assign",
                Target: "result.IsVip",
                Value:  true,
            },
        },
    },
}

// è¾“å…¥æ•°æ®ç»“æ„
type BatchExampleInput struct {
    Customer BatchCustomer `json:"customer"`
    Order    BatchOrder    `json:"order"`
}

type BatchCustomer struct {
    PurchaseCount int     `json:"purchase_count"`
    TotalAmount   float64 `json:"total_amount"`
    VipLevel      int     `json:"vip_level"`
}

type BatchOrder struct {
    Amount float64 `json:"amount"`
}

input := BatchExampleInput{
    Customer: BatchCustomer{
        PurchaseCount: 50,
        TotalAmount:   25000.0,
        VipLevel:      4,
    },
    Order: BatchOrder{
        Amount: 600.0,
    },
}

// æ‰¹é‡æ‰§è¡Œæ‰€æœ‰è§„åˆ™
results, err := dynamicEngine.ExecuteBatch(ctx, rules, input)
if err != nil {
    log.Fatal(err)
}

// å¤„ç†æ¯ä¸ªè§„åˆ™çš„æ‰§è¡Œç»“æœ
for i, result := range results {
    fmt.Printf("è§„åˆ™ %d æ‰§è¡Œç»“æœ: %+v\n", i, result)
}
// ç»“æœ:
// è§„åˆ™ 0 æ‰§è¡Œç»“æœ: {FreeShipping: true}
// è§„åˆ™ 1 æ‰§è¡Œç»“æœ: {LoyaltyScore: 750}
// è§„åˆ™ 2 æ‰§è¡Œç»“æœ: {IsVip: true}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### è§„åˆ™è®¾è®¡åŸåˆ™

#### æ•°æ®åº“å­˜å‚¨è§„åˆ™
1. **å•ä¸€èŒè´£** - æ¯ä¸ªè§„åˆ™ä¸“æ³¨è§£å†³ä¸€ä¸ªç‰¹å®šé—®é¢˜
2. **ä¼˜å…ˆçº§ç®¡ç†** - ä½¿ç”¨ `salience` æ§åˆ¶è§„åˆ™æ‰§è¡Œé¡ºåº
3. **æ˜ç¡®é€€å‡º** - ä½¿ç”¨ `Retract()` é¿å…é‡å¤æ‰§è¡Œ
4. **è¾“å…¥éªŒè¯** - åœ¨è§„åˆ™ä¸­æ£€æŸ¥å¿…è¦çš„è¾“å…¥å‚æ•°

```grl
rule ValidateInput "è¾“å…¥éªŒè¯" salience 1000 {
    when
        userinput == nil || userinput.User.ID == nil
    then
        result["error"] = "ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´";
        result["valid"] = false;
        Retract("ValidateInput");
}
```

#### åŠ¨æ€è§„åˆ™
1. **é€‰æ‹©åˆé€‚çš„è§„åˆ™ç±»å‹**
   - **SimpleRule**: é€‚ç”¨äºç®€å•çš„æ¡ä»¶-ç»“æœæ˜ å°„
   - **MetricRule**: é€‚ç”¨äºæŒ‡æ ‡è®¡ç®—å’Œæ•°æ®åˆ†æ
   - **StandardRule**: é€‚ç”¨äºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘

2. **è¯­æ³•é€‰æ‹©**
   - **SQLè¯­æ³•**: é€‚åˆæ•°æ®åº“èƒŒæ™¯çš„å¼€å‘äººå‘˜
   - **JavaScriptè¯­æ³•**: é€‚åˆå‰ç«¯å¼€å‘äººå‘˜ï¼Œæ”¯æŒå¸¸ç”¨çš„JSè¡¨è¾¾å¼è¯­æ³•

3. **å‡½æ•°ä½¿ç”¨**
   - ä¼˜å…ˆä½¿ç”¨å†…ç½®å‡½æ•°ï¼Œæ€§èƒ½æ›´å¥½
   - è‡ªå®šä¹‰å‡½æ•°æŒ‰éœ€æ³¨å†Œï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–
   - éªŒè¯å‡½æ•°æ”¾åœ¨æ¡ä»¶ä¸­ï¼Œè®¡ç®—å‡½æ•°æ”¾åœ¨åŠ¨ä½œä¸­

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ•°æ®åº“å¼•æ“ä¼˜åŒ–
1. **åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´** - æ ¹æ®è§„åˆ™å˜æ›´é¢‘ç‡è°ƒæ•´TTL
2. **è§„åˆ™åˆ†ç»„** - ä¸åŒä¸šåŠ¡åœºæ™¯ä½¿ç”¨ä¸åŒçš„ `bizCode`
3. **é¿å…å¤æ‚è®¡ç®—** - å°†é‡è®¡ç®—é€»è¾‘å‰ç½®åˆ°è¾“å…¥å‡†å¤‡é˜¶æ®µ
4. **ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡** - å®šæœŸæ£€æŸ¥ç¼“å­˜æ•ˆæœ

#### åŠ¨æ€å¼•æ“ä¼˜åŒ–
1. **å¯ç”¨ç¼“å­˜** - å¯¹äºé‡å¤æ‰§è¡Œçš„è§„åˆ™ï¼Œå¯ç”¨å†…å­˜ç¼“å­˜
2. **å¹¶è¡Œæ‰§è¡Œ** - å¯¹äºç‹¬ç«‹çš„è§„åˆ™ï¼Œä½¿ç”¨æ‰¹é‡å¹¶è¡Œæ‰§è¡Œ
3. **åˆç†è®¾ç½®å¹¶å‘æ•°** - æ ¹æ®ç³»ç»Ÿèµ„æºè®¾ç½® `MaxConcurrency`
4. **é¿å…æ·±å±‚åµŒå¥—** - å¤æ‚æ¡ä»¶å¯ä»¥æ‹†åˆ†ä¸ºå¤šä¸ªç®€å•è§„åˆ™

```go
// æ€§èƒ½ä¼˜åŒ–é…ç½®ç¤ºä¾‹
dynamicEngine := runehammer.NewDynamicEngine[OptimizedResult](
    runehammer.DynamicEngineConfig{
        EnableCache:       true,              // å¯ç”¨ç¼“å­˜
        CacheTTL:          10 * time.Minute,  // åˆç†çš„ç¼“å­˜æ—¶é—´
        MaxCacheSize:      500,               // è¶³å¤Ÿçš„ç¼“å­˜ç©ºé—´
        ParallelExecution: true,              // å¯ç”¨å¹¶è¡Œæ‰§è¡Œ
        DefaultTimeout:    30 * time.Second,  // åˆç†çš„è¶…æ—¶æ—¶é—´
    },
)
```

### å¼•æ“é€‰æ‹©æŒ‡å—

| ä½¿ç”¨åœºæ™¯ | æ¨èå¼•æ“ | ç†ç”± |
|----------|----------|------|
| ä¸šåŠ¡è§„åˆ™ç®¡ç† | æ•°æ®åº“å¼•æ“ | æ”¯æŒçƒ­æ›´æ–°ã€ç‰ˆæœ¬æ§åˆ¶ã€æŒä¹…åŒ–å­˜å‚¨ |
| æŒ‡æ ‡è®¡ç®— | åŠ¨æ€å¼•æ“ | å®æ—¶è®¡ç®—ã€æ— éœ€å­˜å‚¨ã€æ”¯æŒå¤æ‚å…¬å¼ |
| ç¬¬ä¸‰æ–¹é›†æˆ | åŠ¨æ€å¼•æ“ | å¤šæ ¼å¼æ”¯æŒã€è¯­æ³•è½¬æ¢ã€æ ‡å‡†åŒ–æ¥å£ |
| ä¸´æ—¶è§„åˆ™ | åŠ¨æ€å¼•æ“ | å¿«é€Ÿæ‰§è¡Œã€æ— éœ€ç®¡ç†ã€å³ç”¨å³å¼ƒ |
| æ‰¹é‡å¤„ç† | åŠ¨æ€å¼•æ“ | å¹¶è¡Œæ‰§è¡Œã€é«˜æ€§èƒ½ã€æ”¯æŒæ‰¹é‡æ“ä½œ |
| é…ç½®åŒ–è§„åˆ™ | æ•°æ®åº“å¼•æ“ | ç•Œé¢é…ç½®ã€è§„åˆ™ç®¡ç†ã€æƒé™æ§åˆ¶ |

### æ··åˆä½¿ç”¨ç­–ç•¥

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯ä»¥ç»“åˆä¸¤ç§å¼•æ“çš„ä¼˜åŠ¿ï¼š

```go
// åˆå§‹åŒ–ä¸¤ä¸ªå¼•æ“
dbEngine, _ := runehammer.New[BusinessResult](
    runehammer.WithDB(db),
    runehammer.WithRedis("localhost:6379", "", 0),
)

dynamicEngine := runehammer.NewDynamicEngine[MetricResult](
    runehammer.DynamicEngineConfig{
        EnableCache:       true,
        ParallelExecution: true,
    },
)

// ä¸šåŠ¡è§„åˆ™ä½¿ç”¨æ•°æ®åº“å¼•æ“
businessResult, err := dbEngine.Exec(ctx, "user_level_check", input)

// æŒ‡æ ‡è®¡ç®—ä½¿ç”¨åŠ¨æ€å¼•æ“
metricRule := runehammer.MetricRule{
    Name:    "risk_score",
    Formula: "income_score * 0.4 + credit_score * 0.6",
        Variables: map[string]string{
            "income_score": "mixedinput.Customer.Income / 10000",
            "credit_score": "mixedinput.Customer.Credit / 10",
        },
}

metricResult, err := dynamicEngine.ExecuteRuleDefinition(ctx, metricRule, input)
```

### ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

```sql
-- å‘å¸ƒæ–°ç‰ˆæœ¬è§„åˆ™
UPDATE runehammer_rules 
SET version = version + 1, 
    grl = 'æ–°çš„è§„åˆ™å†…å®¹',
    updated_at = NOW()
WHERE biz_code = 'user_discount';

-- å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
UPDATE runehammer_rules 
SET enabled = false 
WHERE biz_code = 'user_discount' AND version > 2;
```

## ğŸ¤ å‚ä¸è´¡çŒ®

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

### ä»£ç è§„èŒƒ

- éµå¾ª Go å®˜æ–¹ä»£ç è§„èŒƒ
- æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
- ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- ä½¿ç”¨ GoConvey BDD æµ‹è¯•é£æ ¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- [Grule è§„åˆ™å¼•æ“](https://github.com/hyperjumptech/grule-rule-engine)
- [GRL è¯­æ³•æ–‡æ¡£](https://hyperjumptech.github.io/grule-rule-engine/)

---

**"æ„¿ç¬¦æ–‡çš„åŠ›é‡ä¸ä½ åŒåœ¨"** âš¡